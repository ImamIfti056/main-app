name: Sync Demo with Main via Copilot

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        type: boolean
        default: false
      skip_validation:
        description: 'Skip validation checks'
        required: false
        type: boolean
        default: false

jobs:
  sync-demo:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      DEMO_REPO_TOKEN: ${{ secrets.DEMO_REPO_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # Step 1: Checkout main-app with full history
      - name: Checkout main-app
        uses: actions/checkout@v4
        with:
          path: main-app
          fetch-depth: 0  # Full history for better diff analysis

      # Step 2: Checkout demo-app
      - name: Checkout demo-app
        uses: actions/checkout@v4
        with:
          repository: ImamIfti056/demo-app
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          path: demo-app
          fetch-depth: 0

      # Step 3: Setup Node.js for Copilot sync script
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Step 4: Install dependencies for sync script
      - name: Install sync script dependencies
        run: |
          cd main-app
          npm install js-yaml --no-save

      # Step 4: Install dependencies for sync script
      - name: Install sync script dependencies
        run: |
          cd main-app
          npm install js-yaml --no-save

      # Step 5: Run Copilot-powered sync orchestrator
      - name: Run intelligent sync with Copilot
        id: copilot-sync
        env:
          MAIN_APP_PATH: ${{ github.workspace }}/main-app
          DEMO_APP_PATH: ${{ github.workspace }}/demo-app
        run: |
          cd main-app
          node .github/scripts/copilot-sync.js
          
          # Check if sync produced results
          if [ -f sync-results.json ]; then
            echo "âœ… Sync completed"
            cat sync-results.json
          else
            echo "âŒ Sync failed - no results file"
            exit 1
          fi

      # Step 6: Check if changes were made
      - name: Check for changes
        id: check-changes
        run: |
          cd demo-app
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in demo-app"
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes to commit"
          fi

      # Step 7: Commit changes to new branch in demo-app
      - name: Commit changes
        if: steps.check-changes.outputs.changes_made == 'true'
        run: |
          cd demo-app
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create new branch for sync
          BRANCH_NAME="sync/copilot-${GITHUB_RUN_ID}"
          git checkout -b "$BRANCH_NAME"
          
          # Stage all changes
          git add .
          
          # Commit with detailed message
          git commit -m "chore(sync): AI-powered sync from main-app

          Main commit: ${GITHUB_SHA::7}
          Workflow: ${GITHUB_RUN_ID}
          
          This commit was automatically generated by the Copilot-powered sync workflow.
          Review the PR description for detailed changes and validation results." || echo "No changes to commit"

      # Step 8: Push branch to demo-app
      - name: Push branch
        if: steps.check-changes.outputs.changes_made == 'true'
        run: |
          cd demo-app
          BRANCH_NAME="sync/copilot-${GITHUB_RUN_ID}"
          git push origin "$BRANCH_NAME"

      # Step 9: Create Pull Request with AI-generated description
      - name: Create Pull Request
        if: steps.check-changes.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.DEMO_REPO_TOKEN }}
        run: |
          cd demo-app
          
          # Read PR description from file
          PR_BODY=""
          if [ -f ../main-app/pr-description.md ]; then
            PR_BODY=$(cat ../main-app/pr-description.md)
          else
            PR_BODY="Automated sync from main-app (${GITHUB_SHA::7})"
          fi
          
          # Create PR targeting dev branch
          gh pr create \
            --title "ðŸ¤– [Auto-Sync] Demo sync from main-app (${GITHUB_SHA::7})" \
            --body "$PR_BODY" \
            --base dev \
            --head "sync/copilot-${GITHUB_RUN_ID}" \
            --label "automated-sync,demo-sync,needs-review"

      # Step 10: Create issue on failure
      - name: Create issue on sync failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.DEMO_REPO_TOKEN }}
        run: |
          cd demo-app
          
          ISSUE_BODY="The automated demo sync workflow failed.
          
          **Main app commit**: ${GITHUB_SHA}
          **Workflow run**: [#${GITHUB_RUN_ID}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})
          **Branch**: main
          
          Please review the workflow logs and fix any issues.
          
          /cc @demo-team"
          
          gh issue create \
            --title "ðŸš¨ Demo sync failed - Run #${GITHUB_RUN_ID}" \
            --body "$ISSUE_BODY" \
            --label "sync-failure,automated"

      # Step 11: Job summary
      - name: Generate job summary
        if: always()
        run: |
          cd main-app
          
          echo "# ðŸ¤– Copilot-Powered Demo Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f sync-results.json ]; then
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat sync-results.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No sync results available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: [Run #${GITHUB_RUN_ID}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})" >> $GITHUB_STEP_SUMMARY
          echo "**Main commit**: \`${GITHUB_SHA::7}\`" >> $GITHUB_STEP_SUMMARY
