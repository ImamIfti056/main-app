name: Sync Demo with Main via LLM

on:
  push:
    branches:
      - main

jobs:
  sync-demo:
    runs-on: ubuntu-latest

    env:
      DEMO_REPO_TOKEN: ${{ secrets.DEMO_REPO_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      IGNORE_PATHS: "src/pages/**,src/demo-specific/**"

    steps:
      # Step 1: Checkout main-app
      - name: Checkout main-app
        uses: actions/checkout@v4
        with:
          path: main-app

      # Step 2: Checkout demo-app
      - name: Checkout demo-app
        uses: actions/checkout@v4
        with:
          repository: ImamIfti056/demo-app
          token: ${{ secrets.DEMO_REPO_TOKEN }}
          path: demo-app

      # Step 3: Generate diff
      - name: Generate main changes diff
        id: generate-diff
        run: |
          git --git-dir=main-app/.git fetch origin main
          git --git-dir=main-app/.git diff --unified=0 ${{ github.event.before }} ${{ github.event.after }} > main_changes.diff
          cat main_changes.diff

      # Step 4: Install Python and dependencies
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai jq

      # Step 5: Call OpenAI to generate patched files
      - name: Generate patched files via OpenAI
        id: llm-patch
        run: |
          PROMPT=$(cat <<EOF
          You are a coding assistant.
          You have the diff of main-app in 'main_changes.diff' and the full demo-app source.
          Task:
          1. Apply only the diff changes to demo-app files.
          2. Preserve intentional demo differences marked with:
             /* DEMO-INTENTIONAL-START */ ... /* DEMO-INTENTIONAL-END */
          3. Do not modify files matching ignore list: ${{ env.IGNORE_PATHS }}
          4. Output JSON in this format:
             { "files": [ { "path": "<relative-path>", "new_content": "<updated content>", "note": "<optional note>" } ] }
          EOF
          )

          python3 - <<PY
          import os, openai, json
          
          openai.api_key = os.environ["OPENAI_API_KEY"]
          
          with open("main_changes.diff", "r") as f:
              diff_text = f.read()
          
          prompt = f"""{PROMPT}\n\nDiff:\n{diff_text}"""
          
          resp = openai.ChatCompletion.create(
              model="gpt-4.1-mini",
              messages=[
                  {"role": "system", "content": "You are a skilled coding assistant."},
                  {"role": "user", "content": prompt}
              ],
              temperature=0
          )

          # Get the model output
          result = resp.choices[0].message.content
          
          with open("llm_output.json", "w") as f:
              f.write(result)
          PY

      # Step 6: Apply patches
      - name: Apply patched files
        run: |
          mkdir -p temp
          cat llm_output.json | jq -c '.files[]' | while read file; do
            path=$(echo "$file" | jq -r '.path')
            content=$(echo "$file" | jq -r '.new_content')
            mkdir -p $(dirname demo-app/$path)
            echo "$content" > demo-app/$path
          done

      # Step 7: Commit changes
      - name: Commit changes
        run: |
          cd demo-app
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b sync/llm-auto-${GITHUB_RUN_ID}
          git add .
          git diff --cached --quiet || git commit -m "chore(sync): LLM auto-sync from main-app (${GITHUB_SHA::7})"

      # Step 8: Push branch
      - name: Push branch
        run: |
          cd demo-app
          git push origin HEAD

      # Step 9: Create PR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: demo-app
          branch: sync/llm-auto-${GITHUB_RUN_ID}
          title: "LLM: Automated Demo Sync"
          body: |
            This PR was automatically generated by an LLM to sync demo-app with main-app.
            Main commit: ${{ github.sha }}
            - Files synced from main-app changes
            - Intentional differences preserved
            - Files in ignore list skipped
